From ed141286a37f6e5ddafb5069347ff5d587e7a4e0 Mon Sep 17 00:00:00 2001
From: Su_Laus <sulau@freenet.de>
Date: Fri, 8 Aug 2025 21:35:30 +0200
Subject: [PATCH] tiffcmp: fix memory leak when second file cannot be opened.

Closes #728, #729

Upstream-Status: Backport [https://gitlab.com/libtiff/libtiff/-/commit/ed141286a37f6e5ddafb5069347ff5d587e7a4e0]
CVE: CVE-2025-9165
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 tools/tiffcmp.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/tools/tiffcmp.c b/tools/tiffcmp.c
index 2a35fe6..f812c7d 100644
--- a/tools/tiffcmp.c
+++ b/tools/tiffcmp.c
@@ -103,7 +103,10 @@ main(int argc, char* argv[])
 		return (2);
 	tif2 = TIFFOpen(argv[optind+1], "r");
 	if (tif2 == NULL)
+	{
+		TIFFClose(tif1);
 		return (2);
+	}
 	dirnum = 0;
 	while (tiffcmp(tif1, tif2)) {
 		if (!TIFFReadDirectory(tif1)) {
-- 
2.25.1

