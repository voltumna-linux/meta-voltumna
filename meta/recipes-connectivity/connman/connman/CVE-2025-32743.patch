From d90b911f6760959bdf1393c39fe8d1118315490f Mon Sep 17 00:00:00 2001
From: Praveen Kumar <praveen.kumar@windriver.com>
Date: Thu, 24 Apr 2025 11:39:29 +0000
Subject: [PATCH] dnsproxy: Fix NULL/empty lookup causing potential crash

In ConnMan through 1.44, the lookup string in ns_resolv in dnsproxy.c
can be NULL or an empty string when the TC (Truncated) bit is set in
a DNS response. This allows attackers to cause a denial of service
(application crash) or possibly execute arbitrary code, because those
lookup values lead to incorrect length calculations and incorrect
memcpy operations.

This patch includes a check to make sure loookup value is valid before
using it. This helps avoid unexpected value when the input is empty or
incorrect.

Fixes: CVE-2025-32743

CVE: CVE-2025-32743

Upstream-Status: Backport [https://git.kernel.org/pub/scm/network/connman/connman.git/commit/?id=d90b911f6760959bdf1393c39fe8d1118315490f]

Signed-off-by: Praveen Kumar <praveen.kumar@windriver.com>
---
 src/dnsproxy.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/dnsproxy.c b/src/dnsproxy.c
index cf1d36c..334dd00 100644
--- a/src/dnsproxy.c
+++ b/src/dnsproxy.c
@@ -1615,6 +1615,9 @@ static int ns_resolv(struct server_data *server, struct request_data *req,
	char *dot, *lookup = (char *) name;
	struct cache_entry *entry;

+	if (!lookup || strlen(lookup) == 0)
+		return -EINVAL;
+
	entry = cache_check(request, &type, req->protocol);
	if (entry) {
		int ttl_left = 0;
--
2.40.0
