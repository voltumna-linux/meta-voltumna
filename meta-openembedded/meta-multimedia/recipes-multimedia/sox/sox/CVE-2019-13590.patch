From aa8f02729962a0ee5e9864de90871fa821f262be Mon Sep 17 00:00:00 2001
From: Mans Rullgard <mans@mansr.com>
Date: Tue, 4 Feb 2020 12:55:18 +0000
Subject: [PATCH] sox-fmt: validate comments_bytes before use (CVE-2019-13590)
 [bug #325]

Cap the comments size to 1 GB to avoid overflows in subsequent
arithmetic.

The missing null check mentioned in the bug report is bogus since
lsx_calloc() returns a valid pointer or aborts.

CVE: CVE-2019-13590
Upstream-Status: Backport [https://github.com/mansr/sox/commit/7b6a889217d62ed7e28188621403cc7542fd1f7e]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/sox-fmt.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/sox-fmt.c b/src/sox-fmt.c
index aad965c..11c8877 100644
--- a/src/sox-fmt.c
+++ b/src/sox-fmt.c
@@ -46,7 +46,9 @@ static int startread(sox_format_t * ft)
       lsx_readdw(ft, &comments_bytes))
     return SOX_EOF;
 
-  if (((headers_bytes + 4) & 7) || headers_bytes < FIXED_HDR + comments_bytes ||
+  if (((headers_bytes + 4) & 7) ||
+      comments_bytes > 0x40000000 || /* max 1 GB */
+      headers_bytes < FIXED_HDR + comments_bytes ||
       (num_channels > 65535)) /* Reserve top 16 bits */ {
     lsx_fail_errno(ft, SOX_EHDR, "invalid sox file format header");
     return SOX_EOF;
