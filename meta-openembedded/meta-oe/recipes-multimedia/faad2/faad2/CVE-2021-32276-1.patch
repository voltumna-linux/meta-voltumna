From 586ac8cf550b63a1d87ec105ea4bf20b6f406591 Mon Sep 17 00:00:00 2001
From: Andrew Wesie <awesie@gmail.com>
Date: Fri, 9 Oct 2020 08:19:48 -0500
Subject: [PATCH] Check for error after each channel decode.

hInfo->error is reset within the decode_* functions. This caused the decoder
to ignore errors for some channels in the error resilience (ER) code path.

Fixes #58.

CVE: CVE-2021-32276
Upstream-Status: Backport [https://github.com/knik0/faad2/commit/b58840121d1827b4b6c7617e2431589af1776ddc]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 libfaad/syntax.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/libfaad/syntax.c b/libfaad/syntax.c
index 4e57efd..af48cd1 100644
--- a/libfaad/syntax.c
+++ b/libfaad/syntax.c
@@ -523,37 +523,61 @@ void raw_data_block(NeAACDecStruct *hDecoder, NeAACDecFrameInfo *hInfo,
             break;
         case 3:
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
             if (hInfo->error > 0)
                 return;
             break;
         case 4:
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
             if (hInfo->error > 0)
                 return;
             break;
         case 5:
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
             if (hInfo->error > 0)
                 return;
             break;
         case 6:
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_sce_lfe(hDecoder, hInfo, ld, ID_LFE);
             if (hInfo->error > 0)
                 return;
             break;
         case 7: /* 8 channels */
             decode_sce_lfe(hDecoder, hInfo, ld, ID_SCE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_cpe(hDecoder, hInfo, ld, ID_CPE);
+            if (hInfo->error > 0)
+                return;
             decode_sce_lfe(hDecoder, hInfo, ld, ID_LFE);
             if (hInfo->error > 0)
                 return;
