From 8331e681c85c3b1893d8d5193783f631bfc07acb Mon Sep 17 00:00:00 2001
From: Changqing Li <changqing.li@windriver.com>
Date: Fri, 16 May 2025 13:42:08 +0800
Subject: [PATCH] tests: Add test for passing invalid UTF-8 to
 soup_header_parse_semi_param_list()

CVE: CVE-2024-52531
Upstream-Status: Backport [https://gitlab.gnome.org/GNOME/libsoup/-/merge_requests/407/diffs?commit_id=825fda3425546847b42ad5270544e9388ff349fe]

Signed-off-by: Changqing Li <changqing.li@windriver.com>
---
 tests/header-parsing-test.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/tests/header-parsing-test.c b/tests/header-parsing-test.c
index b811115..cfcc003 100644
--- a/tests/header-parsing-test.c
+++ b/tests/header-parsing-test.c
@@ -836,6 +836,17 @@ static struct ParamListTest {
 	    { "filename", "t\xC3\xA9st.txt" },
 	  },
 	},
+
+/* This tests invalid UTF-8 data which *should* never be passed here but it was designed to be robust against it. */
+	{ TRUE,
+	  "invalid*=\x69\x27\x27\x93\x93\x93\x93\xff\x61\x61\x61\x61\x61\x61\x61\x62\x63\x64\x65\x0a; filename*=iso-8859-1''\x69\x27\x27\x93\x93\x93\x93\xff\x61\x61\x61\x61\x61\x61\x61\x62\x63\x64\x65\x0a; foo",
+	   {
+		{ "filename", "i''\302\223\302\223\302\223\302\223\303\277aaaaaaabcde" },
+		{ "invalid", "\302\223\302\223\302\223\302\223\303\277aaaaaaabcde" },
+		{ "foo", NULL },
+	   },
+	}
+
 };
 static const int num_paramlisttests = G_N_ELEMENTS (paramlisttests);
 
-- 
2.34.1

