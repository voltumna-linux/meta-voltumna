From c43b7ce784de42511f80b45d741715646cc4fa44 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bern=C3=A1t=20G=C3=A1bor?= <gaborjbernat@gmail.com>
Date: Fri, 9 Jan 2026 10:19:39 -0800
Subject: [PATCH] Merge pull request #3013 from gaborbernat/fix-sec

CVE: CVE-2026-22702
Upstream-Status: Backport [https://github.com/pypa/virtualenv/commit/dec4cec5d16edaf83a00a658f32d1e032661cebc]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/virtualenv/app_data/__init__.py | 11 +++++------
 src/virtualenv/util/lock.py         |  7 +++----
 2 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/src/virtualenv/app_data/__init__.py b/src/virtualenv/app_data/__init__.py
index 148c941..301a00f 100644
--- a/src/virtualenv/app_data/__init__.py
+++ b/src/virtualenv/app_data/__init__.py
@@ -34,12 +34,11 @@ def make_app_data(folder, **kwargs):
     if is_read_only:
         return ReadOnlyAppData(folder)
 
-    if not os.path.isdir(folder):
-        try:
-            os.makedirs(folder)
-            logging.debug("created app data folder %s", folder)
-        except OSError as exception:
-            logging.info("could not create app data folder %s due to %r", folder, exception)
+    try:
+        os.makedirs(folder, exist_ok=True)
+        logging.debug("created app data folder %s", folder)
+    except OSError as exception:
+        logging.info("could not create app data folder %s due to %r", folder, exception)
 
     if os.access(folder, os.W_OK):
         return AppDataDiskFolder(folder)
diff --git a/src/virtualenv/util/lock.py b/src/virtualenv/util/lock.py
index b4dc66a..a28b32f 100644
--- a/src/virtualenv/util/lock.py
+++ b/src/virtualenv/util/lock.py
@@ -15,9 +15,8 @@ from filelock import FileLock, Timeout
 class _CountedFileLock(FileLock):
     def __init__(self, lock_file) -> None:
         parent = os.path.dirname(lock_file)
-        if not os.path.isdir(parent):
-            with suppress(OSError):
-                os.makedirs(parent)
+        with suppress(OSError):
+            os.makedirs(parent, exist_ok=True)
 
         super().__init__(lock_file)
         self.count = 0
@@ -109,7 +108,7 @@ class ReentrantFileLock(PathLockBase):
         # a lock, but that lock might then become expensive, and it's not clear where that lock should live.
         # Instead here we just ignore if we fail to create the directory.
         with suppress(OSError):
-            os.makedirs(str(self.path))
+            os.makedirs(str(self.path), exist_ok=True)
 
         try:
             lock.acquire(0.0001)
