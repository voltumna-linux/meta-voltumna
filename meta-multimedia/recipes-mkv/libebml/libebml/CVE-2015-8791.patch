From 22b87d8217606d891e73fc59a598bae830e61d65 Mon Sep 17 00:00:00 2001
From: Moritz Bunkus <moritz@bunkus.org>
Date: Tue, 20 Oct 2015 14:49:44 +0200
Subject: [PATCH] EbmlElement: don't read beyond end of buffer when reading
 variable length integers

CVE: CVE-2015-8791
Upstream-Status: Backport [https://github.com/Matroska-Org/libebml/commit/24e5cd7c666b1ddd85619d60486db0a5481c1b90]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/EbmlElement.cpp | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/EbmlElement.cpp b/src/EbmlElement.cpp
index 4b96d06..0969468 100644
--- a/src/EbmlElement.cpp
+++ b/src/EbmlElement.cpp
@@ -149,6 +149,11 @@ uint64 ReadCodedSizeValue(const binary * InBuffer, uint32 & BufferSize, uint64 &
 			// ID found
 			PossibleSizeLength = SizeIdx + 1;
 			SizeBitMask >>= SizeIdx;
+
+			// Guard against invalid memory accesses with incomplete IDs.
+			if (PossibleSizeLength > BufferSize)
+				break;
+
 			for (SizeIdx = 0; SizeIdx < PossibleSizeLength; SizeIdx++) {
 				PossibleSize[SizeIdx] = InBuffer[SizeIdx];
 			}
