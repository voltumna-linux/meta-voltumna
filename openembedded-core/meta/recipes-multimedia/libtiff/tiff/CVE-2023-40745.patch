From 4fc16f649fa2875d5c388cf2edc295510a247ee5 Mon Sep 17 00:00:00 2001
From: Arie Haenel <arie.haenel@jct.ac.il>
Date: Wed, 19 Jul 2023 19:34:25 +0000
Subject: [PATCH] tiffcp: fix memory corruption (overflow) on hostile images
 (fixes #591)

Upstream-Status: Backport from [https://gitlab.com/libtiff/libtiff/-/commit/4fc16f649fa2875d5c388cf2edc295510a247ee5]
CVE: CVE-2023-40745
Signed-off-by: Siddharth Doshi <sdoshi@mvista.com>
---
 tools/tiffcp.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/tools/tiffcp.c b/tools/tiffcp.c
index 57eef90..34b6ef2 100644
--- a/tools/tiffcp.c
+++ b/tools/tiffcp.c
@@ -1577,6 +1577,13 @@ DECLAREreadFunc(readSeparateTilesIntoBuffer)
 		TIFFError(TIFFFileName(in), "Error, cannot handle that much samples per tile row (Tile Width * Samples/Pixel)");
 		return 0;
 	}
+
+	if ( (imagew - tilew * spp) > INT_MAX ){
+	    TIFFError(TIFFFileName(in),
+	              "Error, image raster scan line size is too large");
+	    return 0;
+	}
+
 	iskew = imagew - tilew*spp;
 	tilebuf = limitMalloc(tilesize);
 	if (tilebuf == 0)
-- 
2.25.1

