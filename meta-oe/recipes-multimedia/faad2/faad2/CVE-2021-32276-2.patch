From bac3c71781465bb92286e89ef326161bd2500cb4 Mon Sep 17 00:00:00 2001
From: Andrew Wesie <awesie@gmail.com>
Date: Fri, 9 Oct 2020 08:55:52 -0500
Subject: [PATCH] Check for inconsistent number of channels.

The frontend does not support audio output when the number of channels
changes between frames. Check if the number of decoded channels matches the
number of audio output channels.

It is possible that this condition should be detected in the decoder instead
of the frontend.

Fixes crash from afl-fuzz.

CVE: CVE-2021-32276
Upstream-Status: Backport [https://github.com/knik0/faad2/commit/4ed30d3d232b6a7a150cc06aed14eb47e4eda14e]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 frontend/main.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/frontend/main.c b/frontend/main.c
index 3b0850d..39d5276 100644
--- a/frontend/main.c
+++ b/frontend/main.c
@@ -693,6 +693,10 @@ static int decodeAACfile(char *aacfile, char *sndfile, char *adts_fn, int to_std
         /* update buffer indices */
         advance_buffer(&b, frameInfo.bytesconsumed);
 
+        /* check if the inconsistent number of channels */
+        if (aufile != NULL && frameInfo.channels != aufile->channels)
+            frameInfo.error = 12;
+
         if (frameInfo.error > 0)
         {
             faad_fprintf(stderr, "Error: %s\n",
